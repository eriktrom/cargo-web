version: 0.1

phases:
  install:
      commands:
        # Install nodejs https://nodejs.org/en/download/package-manager/
        - curl -sL https://deb.nodesource.com/setup_7.x | bash -
        - apt-get install -y nodejs
        # Install yarn natively https://yarnpkg.com/en/docs/install#linux-tab
        - curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
        - echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
        - apt-get update
        - apt-get install -y yarn
  pre_build:
    commands:
      - echo Installing node dependencies...
      - yarn
  build:
    commands:
      - yarn server
  post_build:
    commands:
      - aws s3 sync --cache-control "max-age=31536000" --acl public-read build/static "s3://${STATIC_BUCKET_NAME}"

artifacts:
  files:
    - appspec.yml
    - app/**/*
    - bin/**/*
    - build/**/*
    - nginx/**/*
    - server.js
